# 实验3-2：FPGA深度学习加速器：VTA

### 实验名称

FPGA深度学习加速器：VTA

### 实验目的

1. 了解深度学习加速器VTA的基本原理
1. 掌握VTA环境的基本搭建方法

### 实验任务

1. 配置VTA模拟器运行环境
1. 配置VTA FPGA运行环境

### 实验结果

![img](https://course.educg.net/userfiles/markdown/exp/2023_4/24080ll1681351016.png)

### 实验分析

1. 涉及知识点：

   - VTA深度学习加速器的基本概念

   ![img](https://course.educg.net/userfiles/markdown/exp/2023_4/24080ll1681351035.png)

    通用张量加速器（Versatile Tensor Accelerator，VTA）是一个开源、通用、可定制化的深度学习加速器，他采用完整的基于TVM的编译栈。 设计VTA的目的是展示主流深度学习加速器最显著和通用的特征。 TVM和VTA共同构成了一个端到端的硬件软件深度学习系统堆栈，其中囊括了硬件设计，驱动设计，即时的运行环境，以及基于TVM的优化编译栈。

   - VTA具有以下的特征：
     - 通用、模块化的开源硬件
     - 适配FPGA的精简工作流
     - 可支持常规工作环境下原型编译的模拟器
     - 基于PYNQ的驱动程序和实时运行环境，可支持仿真和FPGA硬件后端
     - 端到端的TVM堆栈集成

1. 涉及技能点：

   - 掌握VTA运行环境的配置方法

### 实验步骤

1. #### 配置VTA模拟器运行环境

   > 此步骤在宿主机完成，github无法连接时可将`github.com`地址更换为`hub.fastgit.xyz`

   1. 下载特定TVM版本：由于TVM内容更新较快，版本管理并不能算得上优秀，经常出现新旧版本不兼容的问题。因此，本实验需要下载特定版本的TVM

      ```
      版本hash：09c55fd1f3354d2280bb792a252590ac6bd68e58
      ```

      可通过`https://github.com/apache/tvm/tree/09c55fd1f3354d2280bb792a252590ac6bd68e58`链接访问该版本TVM内容

      该版本能够适配开发板上的gcc、cmake版本，且依赖python库在开发板已安装

   1. 配置环境变量

      ```shell
      export TVM_PATH=/path/to/tvm
      # export VTA_HW_PATH=$TVM_PATH/3rdparty/vta-hw # 本行在09c55fd1f版本不需配置
      ```

   1. 配置VTA仿真功能库

      此步骤在先前的TVM配置中已完成，未完成的可参考以下步骤重新进行构建，注意宿主机侧仍然需要配置LLVM，LLVM-9已提供在实验数据处

      ```sh
      # 切换至TVM目录下
      cd /path/to/tvm
      # 创建build文件夹
      mkdir build
      # 将配置文件拷贝至目录下
      cp cmake/config.cmake build/.
      # 将配置内容追加到配置文件末尾
      echo 'set(USE_VTA_FSIM ON)' >> build/config.cmake
      # 切换目录并执行构建
      cd build && cmake .. && make -j4
      ```

      > 注：配置文件从前到后进行读取，相同项的配置，后部配置将覆盖前部配置

   1. 将VTA python运行库添加到python库路径中

      ```shell
      export PYTHONPATH=$TVM_PATH/python:$TVM_PATH/vta/python:$TVM_PATH/topi/python:${PYTHONPATH}
      ```

   1. 测试VTA安装结果

      至此，VTA模拟器环境配置完成，可通过以下命令测试VTA对卷积运算的支持

      ```shell
      python37 <tvm root>/vta/tests/python/integration/test_benchmark_topi_conv2d.py
      ```

1. #### 配置VTA FPGA运行环境

   1. 将TVM压缩包上传至开发板

      > 注：建议通过Jupyter Notebook进行上传，直接拷贝至FPGA目录可能会产生权限错误

   1. 解压并构建VTA运行环境

      ```shell
      # 解压TVM
      tar -zxvf tvm.tar.gz
      # 进入目录
      cd /path/to/tvm
      # 创建构建目录
      mkdir build
      # 拷贝配置文件
      cp cmake/config.cmake build/.
      # 追加VTA配置
      echo 'set(USE_VTA_FPGA ON)' >> build/config.cmake
      # 拷贝并修改VTA运行配置
      cp 3rdparty/vta-hw/config/pynq_sample.json 3rdparty/vta-hw/config/vta_config.json # vta-hw的config在09c55fd1f版本不需配置
      cp vta/config/pynq_sample.json vta/config/vta_config.json
      # 构建
      cd build
      cmake ..
      make runtime vta -j2
      ```

      其中VTA运行配置应修改为

      ```
      {
        "TARGET": "pynq",
        "HW_VER": "0.0.1",
        "LOG_INP_WIDTH": 3,
        "LOG_WGT_WIDTH": 3,
        "LOG_ACC_WIDTH": 5,
        "LOG_BATCH": 0,
        "LOG_BLOCK": 4,
        "LOG_UOP_BUFF_SIZE": 15,
        "LOG_INP_BUFF_SIZE": 15,
        "LOG_WGT_BUFF_SIZE": 18,
        "LOG_ACC_BUFF_SIZE": 17,
        "LOG_BLOCK_IN": 4,
        "LOG_BLOCK_OUT": 4,
        "LOG_OUT_WIDTH": 3,
        "LOG_OUT_BUFF_SIZE": 15
      }
      ```

   1. 配置开发板环境变量

      ```shell
      export TVM_HOME=/path/to/tvm
      export PYTHONPATH=$TVM_HOME/python:$TVM_HOME/vta/python:$TVM_HOME/topi/python:/home/xilinx/pynq:${PYTHONPATH}
      # export VTA_HW_PATH=$TVM_PATH/3rdparty/vta-hw # 本行在09c55fd1f版本不需配置
      ```

   1. 启动RPC服务器

      ```shell
      cd ..
      python3 -m vta.exec.rpc_server --port 9095
      ```

      出现以下内容时说明正常启动RPC服务器

      ```
      INFO:root:RPCServer: bind to 0.0.0.0:9095
      ```

1. #### 使用宿主机调用FPGA VTA环境

   1. 测试VTA FPGA运行环境是否正常运行

      配置VTA RPC服务地址

      ```shell
      export VTA_PYNQ_RPC_HOST=开发板IP
      export VTA_PYNQ_RPC_PORT=开发板VTA服务映射端口
      ```

      > 由于开发板与桌面环境不在同一网段，因此需要查看开发板所映射出9095端口信息，即”VTA服务端口“

   1. 配置宿主机VTA运行环境参数

      ```shell
      # cp 3rdparty/vta-hw/config/pynq_sample.json 3rdparty/vta-hw/config/vta_config.json # 本行在09c55fd1f版本不需配置
      cd /path/to/tvm/vta/config
      mv vta_config.json vta_config_sim.json
      cp pynq_sample.json vta_config.json
      ```

      > vta_config.json配置了VTA运算时的相关参数，调整后需要重新生成比特流文件

   1. 测试VTA RPC连通性

      ```shell
      python37 vta/tests/python/pynq/test_program_rpc.py
      ```

   1. 再次运行2D卷积测试用例

      ```
      python37 vta/tests/python/integration/test_benchmark_topi_conv2d.py
      ```

### 问题思考

1. 自学VTA矩阵乘法案例并提交结果

### 参考资料

TVM：https://tvm.apache.org/docs/index.html

VTA：https://tvm.apache.org/docs/vta/index.html

VTA矩阵乘法案例：https://tvm.apache.org/docs/vta/tutorials/matrix_multiply.html#sphx-glr-vta-tutorials-matrix-multiply-py