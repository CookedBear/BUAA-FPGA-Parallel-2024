### 1. 实验1：在线实验平台使用及初识PYNQ# 实验1：在线平台使用及初识PYNQ

### 实验名称

在线平台使用及初识PYNQ

### 实验目的

1. 了解在线实验平台的基本使用方式
1. 了解PYNQ平台的使用方法
1. 了解PNYQ平台FPGA软硬件协同的基本开发流程

### 实验任务

1. 访问在线实验平台，分组建立工作目录，将本次实验的相关材料上传至工作目录
1. 使用Vivado工具，完成PYNQ Overlay的完整制作
1. 使用SciPy构建软件滤波器，并使用PYNQ平台运行，分析软件滤波器的执行时间
1. 使用PYNQ加载已制作的硬件Overlay文件，调用并分析硬件滤波器的执行时间

### 实验结果

![img](https://course.educg.net/userfiles/markdown/exp/2021_3/84467ll1615177279.png)

### 实验分析

涉及知识点：

- PYNQ的基本架构，PS/PL协同工作原理

涉及技能点：

- PYNQ Overlay的模块设计基本方法及IP核的调用过程
- PYNQ Overlay的生成及使用过程

### 实验步骤

1. #### 在线实验平台基本操作

   1. 建立工作目录

      由于课程平台采用虚拟化的方式对实验环境进行管理。在实验结束后，实验环境将被销毁并释放资源。因此，为防止文件丢失，需要在`/mnt/cgshare`目录下建立本组的工作目录并将相关实验材料存储至该目录下。

      ![img](https://course.educg.net/userfiles/markdown/exp/2021_3/84467ll1615177297.png)

   1. 上传与下载文件

      课程平台采用虚拟化方式创建在线实验环境，在线实验环境与外部操作系统完全隔离，因此，若需要进行内外环境的文件交换，需要通过平台的上传/下载文件功能实现。

      ![img](https://course.educg.net/userfiles/markdown/exp/2021_3/84467ll1615177312.png)

      点击`“更多”`选项，选择`“下载远程桌面内的文件”`，输入文件名，即可下载。

      ![img](https://course.educg.net/userfiles/markdown/exp/2021_3/84467ll1615177398.png)

      点击`“更多”`选项，选择`“上传文件至远程桌面”`，选择文件，点击`“上传”`，即可将所选择的文件上传至`“/mnt/cgshare”`文件夹下。

      ![img](https://course.educg.net/userfiles/markdown/exp/2021_3/84467ll1615177414.png)

   1. 获取开发板资源

      双击桌面上的`申请FPGA开发板`图标，即可进入开发板管理界面，桌面上的FPGA文件夹在申请成功开发板后将挂载至`Jupyter Notebook`开发环境下。

      ![img](https://course.educg.net/userfiles/markdown/exp/2021_3/84467ll1615177423.png)

      在开发板管理界面，点击确认申请，可申请FPGA开发板进行实验（实验过程中请勿关闭此界面）

      ![img](https://course.educg.net/userfiles/markdown/exp/2021_3/84467ll1615177441.png)

      将鼠标移动至Info位置的感叹号时，将显示开发板的访问地址，通过此地址即可访问开发板`Jupyter Notebook`环境，默认登陆密码为`xilinx`。

      ![img](https://course.educg.net/userfiles/markdown/exp/2021_3/84467ll1615177468.png)

      在实验完成后，可点击管理界面中`Operate`下方的`释放`按钮释放开发板资源。

1. #### 硬件滤波器Overlay的制作

   > 此部分制作包括两种方式，若采用PYNQ-Z1、PYNQ-Z2等板卡，由于Vivado内置了板卡信息，可直接按照步骤1选择板卡型号，并按照步骤2添加模块即可进行实验
   >
   >  
   >
   > 若采用与上述板卡不同的开发板，则可以通过上传板级支持包的方式，采用该基本工程中的`ZYNQ7 Processing System`模块，删除多余连线后，按步骤2指示，添加其他模块后继续实验

   1. 打开Vivado，创建新工程，工程类型为`RTL Project`，板卡型号选择`pynq-z2`

      ![img](https://course.educg.net/userfiles/markdown/exp/2021_3/84467ll1615177505.png)

   1. 在左侧菜单中，选择`IP INTEGRATOR`下的`Create Block Design`项，创建模组设计并在模组中添加`ZYNQ7 Processing System`、`FIR Compiler`和`AXI Direct Memory Access`这三个模块

   ![img](https://course.educg.net/userfiles/markdown/exp/2021_3/84467ll1615177521.png)

   1. 完成模块添加后，对模块进行修改
      - 双击`ZYNQ7 Processing System`模块，做如下修改：
        1. 选择`PS-PL Configuration`页，勾选`HP Slave AXI Interface`页的`S AXI HP0 interface`，启用PS端的AXI协议数据传输接口
      - 双击`FIR Compiler`滤波器模块，做如下修改：
        1. 修改其中的系数向量（系数向量详见后部软件实现滤波器部分）。
        1. 在`Channel Specification`页修改采样频率与时钟频率均为100MHz。
        1. 在`Implementation`页面修改`Output Rounding Mode`为`Non Symmetric Rounding Up`，修改输入输出数据位宽为32位。
        1. 在`Interface`页面设置`TLAST`为`Packet Framing`，并勾选`Output TREADY`以输出TREADY信号。
      - 双击`AXI Direct Memory Access`模块，做如下修改：
        1. 取消勾选`Enable Scatter Gather Engine`，此处不需要非连续地址的数据传输，故可关闭SG模式
        1. `Width of Buffer Length Register`设置为23位
   1. 点击`Run Block Automation`进行自动添加附加模块。
   1. 将`FIR Compiler`的`M_AXIS_DATA`端口与`AXI Direct Memory Access`的`S_AXIS_S2MM`端口相连，用于将DMA模块的数据传输给滤波器模块。
   1. 将`FIR Compiler`的`S_AXIS_DATA`端口与`AXI Direct Memory Access`的`M_AXIS_MM2S`端口相连，用于将滤波器模块的输出结果回传给DMA模块。

   ![img](https://course.educg.net/userfiles/markdown/exp/2021_3/84467ll1615177531.png)

   1. 在`Block Properties`中对`AXI Direct Memory Access`模块进行改名，此处修改为`fir_dma`，并将`FIR Compiler`模块改名为`fir`，同时选中`fir`和`fir_dma`模块，点击右键，选择`Create Hieracty`，创建层次，并将其命名为`filter`
   1. 点击`Run Connection Automation`进行自动连线，连线过程中勾选`All Automation`（注：此处的自动连线需要执行两次）。
   1. 切换至`Sources`分页，选择当前的`Design Sources`，点击右键，选择菜单中的`Create HDL Wrapper`，生成顶层包装（将模块设计包装起来）
   1. 选择`Generate Bitstream`，生成Overlay所需要的比特流文件，注意，在点选之后，综合（`Synthesis`）和执行（`implementation`）均会在后台运行，此刻可查看界面右上角是否有流程未完成，或打开Log界面查看当前任务所输出的日志。
   1. 分别选择`File`菜单下的`Export`中的`Export Bitstream File`、`Export Block Design`导出比特流文件.bit和模块设计的tcl约束文件，并在`工程名.srcs/sources_1/bd/design_1/hw_handoff`文件夹下找到.hwh的硬件描述文件，将此三个文件改为同一文件名存放至同一工作目录下，即可作为PYNQ平台的Overlay进行使用。

   > 说明：
   >
   >  
   >
   > `ZYNQ7 Processing System`为ZYNQ7系列板卡（如xc7z020、xc7z100，PYNQ-Z2板卡使用的是xc7z020）所设计的PS侧资源的抽象模块。
   >
   >  
   >
   > `FIR Compiler`为Xilinx所内置的滤波器IP核（IP核为预先设计好的电路功能模块），修改其中的系数向量（Coefficient Vector），即可实现所需要的滤波功能。
   >
   >  
   >
   > `TLAST`选择为`Packet Framing`时，每个数据帧完成后将传出信号，数据将按包接收
   >
   >  
   >
   > `TREADY`勾选时将输出`TREADY`信号，其与`TVALID`信号实现了握手

1. #### 软件滤波器的构建

   工具方法：

   - 定义图像绘制函数，time_sec为时间序列，in_signal为输入信号序列，n_samples为绘制范围，out_signal为额外的输出信号序列。

     ```python
     %matplotlib notebook
     import matplotlib.pyplot as plt
     
     def plot_to_notebook(time_sec, in_signal, n_samples, out_signal=None):
             plt.figure()
             plt.subplot(1, 1, 1)
             plt.xlabel('Time (usec)')
             plt.grid()
             plt.plot(time_sec[:n_samples]*1e6,in_signal[:n_samples],'y-',label='Input signal')
             if out_signal is not None:
                     plt.plot(time_sec[:n_samples]*1e6,out_signal[:n_samples],'g-',linewidth=2,label='FIR output')
             plt.legend()
     ```

   1. 针对本次实验，首先需要构建原始信号

      ```python
      import numpy as np
      #模拟信号源生成输入信号
      T = 0.002 # 采样时间范围
      fs = 100e6 # 采样频率
      n = int(T * fs) # 采样点数
      t = np.linspace(0, T, n, endpoint=False) # 生成时间序列
      
      samples = 10000*np.sin(0.2e6*2*np.pi*t) + 1500*np.cos(46e6*2*np.pi*t) + 2000*np.sin(12e6*2*np.pi*t)
      # 信号源为200kHz的正弦信号，46MHz和12MHz的低幅度信号作为输入的模拟噪声。
       
      samples = samples.astype(np.int32)   # 将样本转换为32位整数
      print('Number of samples: ',len(samples))
      #输出采样点数
      plot_to_notebook(t,samples,1000)  
      #画图
      ```

   1. 使用SciPy中的`lfilter`方法进行对输入信号进行滤波，并记录软件滤波器执行耗时

      滤波器系数向量可通过`http://t-filter.engineerjs.com/`生成

      ```Python
      # 采用SciPy函数调用的软件FIR滤波器
      from scipy.signal import lfilter
      coeffs = [-255,-260,-312,-288,-144,153,616,1233,1963,2739,3474,4081,4481,4620,4481,4081,3474,2739,1963,1233,616,153,-144,-288,-312,-260,-255]
      # 滤波器系数向量，生成0-5MHz频带的低通滤波器。
      import time
      start_time = time.time()
      sw_fir_output = lfilter(coeffs,70e3,samples)
      stop_time = time.time()
      sw_exec_time = stop_time - start_time
      print('软件滤波器执行时间：',sw_exec_time) # 输出软件滤波器的执行耗时。
       
      # 画图
      plot_to_notebook(t,samples,1000,out_signal=sw_fir_output)
      ```

      通过滤波，可将高于5MHz的信号过滤掉。

1. #### 硬件滤波器Overlay的使用

   1. 将生成的Overlay（.bit，.hwh，.tcl三个文件）拷贝到工作目录下

   1. 使用PYNQ的xlnk类，申请输入输出缓冲区，并使用dma对输入数据和输出数据进行处理

      ```python
      #硬件滤波器实现
      from pynq import Overlay, Xlnk
      import pynq.lib.dma
      import numpy as np
      import time
       
      overlay = Overlay('./accel.bit')  # 加载overlay文件
      dma = overlay.filter.fir_dma  # 加载滤波器的DMA
       
      # 为输入和输出信号分配缓冲区
      xlnk = Xlnk()
      # 申请内存地址连续的numpy数组作为输入输出缓冲区
      in_buffer = xlnk.cma_array(shape=(n,), dtype=np.int32) 
      out_buffer = xlnk.cma_array(shape=(n,), dtype=np.int32)
      
      # 将信号拷贝至输入缓冲区
      np.copyto(in_buffer,samples)
      
      start_time = time.time() # 读取开始的时间点
      dma.sendchannel.transfer(in_buffer)
      dma.recvchannel.transfer(out_buffer)
      dma.sendchannel.wait()
      dma.recvchannel.wait()
      stop_time = time.time()  # 读取结束的时间点
      hw_exec_time = stop_time-start_time
      print('硬件滤波器执行时间: ',hw_exec_time)  #输出硬件滤波器的滤波耗时
      print('硬件加速效果: ',sw_exec_time / hw_exec_time) #输出加速比
       
      # 画图
      plot_to_notebook(t,samples,1000,out_signal=out_buffer)
       
      # 释放缓冲区
      in_buffer.close()
      out_buffer.close()
      ```

      ![img](https://course.educg.net/userfiles/markdown/exp/2021_3/84467ll1615177621.png)

### 问题思考

1. 计算回答为何`AXI Direct Memory Access`模块的`Width of Buffer Length Register`设置为23位

1. 参考[Python Overlay API的文档](https://pynq.readthedocs.io/en/v2.6.1/overlay_design_methodology/python_overlay_api.html)，通过对Overlay类进行封装，实现滤波过程的驱动编写

   > 提示：
   >
   > 1. 可将功能封装为自定义的Overlay
   > 1. 文档中`DefaultOverlay`类应当为`Overlay`类，且父类`__init__`方法中download不为必须参数

1. 请思考或建立新工程尝试，若省略2-7的`Create Hieracty`步骤，则可通过什么其他方式对DMA模块进行访问？

   > 提示：
   >
   >  
   >
   > 可通过`overlay?`的方式查看Overlay的相关说明

### 参考资料

- PYNQ官方文档：https://pynq.readthedocs.io/en/v2.6.1/
- AXI4-Stream协议文档：https://www.xilinx.com/support/documentation/ip_documentation/axis_interconnect/v1_1/pg035_axis_interconnect.pdf

### 相关资源

- 板级支持包：[py0724_base.zip](https://course.educg.net/userfiles/markdown/exp/2022_4/8283ll1649228483.zip)
- 实验报告模板：[实验1：实验报告模板.doc](https://course.educg.net/userfiles/markdown/exp/2022_4/8283ll1649228502.doc)